services:
  postgres:
    image: 'pgvector/pgvector:pg16'
    restart: unless-stopped
    environment:
      POSTGRES_USER: '${POSTGRES_USER}'
      POSTGRES_PASSWORD: '${POSTGRES_PASSWORD}'
      POSTGRES_DB: '${POSTGRES_DB}'
    volumes:
      - 'postgres_data:/var/lib/postgresql/data'
    healthcheck:
      test:
        - CMD-SHELL
        - 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}'
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  api:
    image: 'ghcr.io/jose-ribeir/geminimesh/api:latest'
    restart: unless-stopped
    environment:
      PORT: 4000
      DATABASE_URL: 'postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}'
      REDIS_URL: 'redis://redis:6379'
      RAG_PROVIDER: pgvector
      LLM_PROVIDER: groq
      GROQ_API_KEY: '${GROQ_API_KEY}'
      GEMINI_API_KEY: '${GEMINI_API_KEY}'
      GEMINIMESH_REQUEST_TIMEOUT: '${GEMINIMESH_REQUEST_TIMEOUT}'
      MINIO_ENDPOINT: '${MINIO_ENDPOINT}'
      MINIO_ACCESS_KEY: '${MINIO_ACCESS_KEY}'
      MINIO_SECRET_KEY: '${MINIO_SECRET_KEY}'
      MINIO_BUCKET: '${MINIO_BUCKET}'
      MINIO_SECURE: '${MINIO_SECURE}'
      STORAGE_PROVIDER: '${STORAGE_PROVIDER}'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend

  worker:
    image: 'ghcr.io/jose-ribeir/geminimesh/api:latest'
    restart: unless-stopped
    command: python -m app.worker
    environment:
      DATABASE_URL: 'postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}'
      REDIS_URL: 'redis://redis:6379'
      RAG_PROVIDER: pgvector
      LLM_PROVIDER: groq
      GROQ_API_KEY: '${GROQ_API_KEY}'
      GEMINI_API_KEY: '${GEMINI_API_KEY}'
      GEMINIMESH_REQUEST_TIMEOUT: '${GEMINIMESH_REQUEST_TIMEOUT}'
      MINIO_ENDPOINT: '${MINIO_ENDPOINT}'
      MINIO_ACCESS_KEY: '${MINIO_ACCESS_KEY}'
      MINIO_SECRET_KEY: '${MINIO_SECRET_KEY}'
      MINIO_BUCKET: '${MINIO_BUCKET}'
      MINIO_SECURE: '${MINIO_SECURE}'
      STORAGE_PROVIDER: '${STORAGE_PROVIDER}'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend

  worker-prompt:
    image: 'ghcr.io/jose-ribeir/geminimesh/api:latest'
    restart: unless-stopped
    command: python -m app.prompt_worker
    environment:
      DATABASE_URL: 'postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}'
      REDIS_URL: 'redis://redis:6379'
      RAG_PROVIDER: pgvector
      LLM_PROVIDER: groq
      GROQ_API_KEY: '${GROQ_API_KEY}'
      GEMINI_API_KEY: '${GEMINI_API_KEY}'
      GEMINIMESH_REQUEST_TIMEOUT: '${GEMINIMESH_REQUEST_TIMEOUT}'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend

  web:
    image: 'ghcr.io/jose-ribeir/geminimesh/web:latest'
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      VITE_API_URL: '${VITE_API_URL}'
      VITE_APP_URL: '${VITE_APP_URL}'
    depends_on:
      - api
    networks:
      - backend

  minio:
    image: 'minio/minio:latest'
    restart: unless-stopped
    command: 'server /data --console-address ":9001"'
    environment:
      MINIO_ROOT_USER: '${MINIO_ROOT_USER}'
      MINIO_ROOT_PASSWORD: '${MINIO_ROOT_PASSWORD}'
    volumes:
      - 'minio_data:/data'
    ports:
      - '9000:9000'
      - '9001:9001'
    labels:
      - traefik.enable=true
      - traefik.http.routers.minio.rule=Host(`storage.geminimesh.com`)
      - traefik.http.routers.minio.entrypoints=websecure
      - traefik.http.routers.minio.service=minio
      - traefik.http.services.minio.loadbalancer.server.port=9000
    healthcheck:
      test:
        - CMD
        - mc
        - ready
        - local
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - backend

networks:
  backend:
    driver: bridge

volumes:
  postgres_data: null
  redis_data: null
  minio_data: null
