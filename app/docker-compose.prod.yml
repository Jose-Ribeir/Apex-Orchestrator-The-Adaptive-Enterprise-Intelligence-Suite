services:
  postgres:
    image: 'pgvector/pgvector:pg16'
    restart: unless-stopped
    environment:
      POSTGRES_USER: '${POSTGRES_USER}'
      POSTGRES_PASSWORD: '${POSTGRES_PASSWORD}'
      POSTGRES_DB: '${POSTGRES_DB}'
    volumes:
      - 'postgres_data:/var/lib/postgresql/data'
    healthcheck:
      test:
        - CMD-SHELL
        - 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}'
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend
  api:
    image: 'ghcr.io/jose-ribeir/geminimesh/api:latest'
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: 'postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}'
      BETTER_AUTH_SECRET: '${BETTER_AUTH_SECRET}'
      BETTER_AUTH_URL: '${BETTER_AUTH_URL}'
      GOOGLE_CLIENT_ID: '${GOOGLE_CLIENT_ID}'
      GOOGLE_CLIENT_SECRET: '${GOOGLE_CLIENT_SECRET}'
      APP_URL: '${APP_URL}'
      PYTHON_API_URL: '${PYTHON_API_URL}'
      SQL_LOGGING: 'false'
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend
  web:
    image: 'ghcr.io/jose-ribeir/geminimesh/web:latest'
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      VITE_API_URL: '${VITE_API_URL}'
      VITE_APP_URL: '${VITE_APP_URL}'
    depends_on:
      - api
    networks:
      - backend
  minio:
    image: 'minio/minio:latest'
    restart: unless-stopped
    command: 'server /data'
    environment:
      MINIO_ROOT_USER: '${MINIO_ROOT_USER}'
      MINIO_ROOT_PASSWORD: '${MINIO_ROOT_PASSWORD}'
    volumes:
      - 'minio_data:/data'
    # Expose via Traefik at https://storage.geminimesh.com (Coolify proxy)
    labels:
      - traefik.enable=true
      - traefik.http.routers.minio.rule=Host(`storage.geminimesh.com`)
      - traefik.http.routers.minio.entrypoints=websecure
      - traefik.http.routers.minio.service=minio
      - traefik.http.services.minio.loadbalancer.server.port=9000
    ports:
      - '9000:9000'
      - '9001:9001'
    healthcheck:
      test:
        - CMD
        - mc
        - ready
        - local
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - backend
networks:
  backend:
    driver: bridge
volumes:
  postgres_data: null
  minio_data: null
